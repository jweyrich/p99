<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>P99: p99_futex::P99_FUTEX_COMPARE_EXCHANGE</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">P99
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="structp99__futex.html">p99_futex</a></li>  </ul>
</div>
</div><!-- top -->
<div class="contents">
<table cellspacing="0" cellpadding="0" border="0">
  <tr>
   <td valign="top">
      <div class="navtab">
        <table>
          <tr><td class="navtab"><a class="qindex" href="group__futex_ga805fff4efe80ea7e2553f6abf0fd1621.html#ga805fff4efe80ea7e2553f6abf0fd1621">p99_futex_add</a></td></tr>
          <tr><td class="navtab"><a class="qindexHL" href="structp99__futex_ad22d35b3a2af941a484a6e06a5e46106.html#ad22d35b3a2af941a484a6e06a5e46106">P99_FUTEX_COMPARE_EXCHANGE</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__futex_gac30811f76a7f0734e34e2d86a41965d2.html#gac30811f76a7f0734e34e2d86a41965d2">p99_futex_destroy</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__futex_ga5f3a21217d8b30a26562eaf0a9fa742a.html#ga5f3a21217d8b30a26562eaf0a9fa742a">p99_futex_exchange</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__futex_ga32fa44dd0ab812e0dfdfff658fdd0552.html#ga32fa44dd0ab812e0dfdfff658fdd0552">p99_futex_init</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__futex_ga94890012858ca4b360a0733de64a0116.html#ga94890012858ca4b360a0733de64a0116">p99_futex_load</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="structp99__futex_a926efa02d7a8893ca806f2e8ca977aa9.html#a926efa02d7a8893ca806f2e8ca977aa9">P99_FUTEX_MAX_WAITERS</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__futex_ga918f22eb5c3fab10bbc0e27e15da511b.html#ga918f22eb5c3fab10bbc0e27e15da511b">p99_futex_wait</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__futex_ga2f178f4b43246a2860289e04769ada88.html#ga2f178f4b43246a2860289e04769ada88">p99_futex_wakeup</a></td></tr>
        </table>
      </div>
   </td>
   <td valign="top" class="mempage">
<a id="ad22d35b3a2af941a484a6e06a5e46106"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad22d35b3a2af941a484a6e06a5e46106">&#9670;&nbsp;</a></span>P99_FUTEX_COMPARE_EXCHANGE</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">#define P99_FUTEX_COMPARE_EXCHANGE</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">FUTEX, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">ACT, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">EXPECTED, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">DESIRED, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">WAKEMIN, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">WAKEMAX&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">related</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>a catch all macro to operate on <a class="el" href="structp99__futex.html" title="A counter similar to a conditional variable that allows atomic increment and decrement and to wait fo...">p99_futex</a> </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">FUTEX</td><td>a pointer that is compatible to <code><a class="el" href="structp99__futex.html" title="A counter similar to a conditional variable that allows atomic increment and decrement and to wait fo...">p99_futex</a> volatile*</code></td></tr>
    <tr><td class="paramname">ACT</td><td>an identifier that can be used in the following parameters. If used there it will correspond to local <code>register</code> variable of type <code>unsigned const</code> holding the actual value of the futex. That variable cannot be modified and its address cannot be taken.</td></tr>
  </table>
  </dd>
</dl>
<p>The other parameters are expressions that may contain arbitrary code that is valid at the point of calling this macro. The evaluation may include the local variable <em>ACT</em>. Here is a pseudo code of what this macro actually does:</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (;;) {</div>
<div class="line">  <span class="keyword">register</span> <span class="keywordtype">unsigned</span> <span class="keyword">const</span> ACT = &lt;load value from FUTEX&gt;;</div>
<div class="line">  <span class="keywordflow">if</span> (EXPECTED) {</div>
<div class="line">    <span class="keywordflow">if</span> (ACT != (DESIRED)) {</div>
<div class="line">      &lt;<span class="keywordflow">try</span> to change value of FUTEX to DESIRED&gt;;</div>
<div class="line">      <span class="keywordflow">if</span> (&lt;not successful&gt;) <span class="keywordflow">continue</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordtype">unsigned</span> wmin = (WAKEMIN);</div>
<div class="line">    <span class="keywordtype">unsigned</span> wmax = (WAKEMAX);</div>
<div class="line">    <span class="keywordflow">if</span> (wmin &lt; wmax) wmax = wmin;</div>
<div class="line">    &lt;wakeup at least wmin and at most wmax waiters&gt;</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    &lt;block and wait until a change is signaled on FUTEX&gt;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Only that each of the macro parameters is expanded exactly once for the C code. As this is a loop structure the code resulting from that argument expansion of <em>EXPECTED</em> and <em>DESIRED</em> may effectively be evaluated multiple times at run time, in particular when there is congestion on the futex.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">EXPECTED</td><td>is an expression that is interpreted as a Boolean condition. The calling thread will be blocked until this expression evaluates to <code>true</code>.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section remark"><dt>Remarks</dt><dd><em>EXPECTED</em> should never be set to the constant <code>false</code>, since will result in the thread being blocked in the <code>for</code> loop.</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">DESIRED</td><td>is an expression that is interpreted as an <code>unsigned</code>. Once the futex fulfills the condition <em>EXPECTED</em> the futex is atomically set to that value if necessary.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section warning"><dt>Warning</dt><dd><em>EXPECTED</em> and <em>DESIRED</em> may be evaluated several times if the underlying atomic compare exchange operations fails temporarily. So you should not have destructive side effects in these expressions.</dd></dl>
<p>After the futex value has been set atomically to the desired value, waiters may be woken up.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">WAKEMIN</td><td>is an expression that is interpreted as an <code>unsigned</code> that should not exceed <a class="el" href="structp99__futex_a926efa02d7a8893ca806f2e8ca977aa9.html#a926efa02d7a8893ca806f2e8ca977aa9" title="the maximum number of waiters that an p99_futex may have">P99_FUTEX_MAX_WAITERS</a>. The calling thread will block until it has woken up at least that number of waiters.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section warning"><dt>Warning</dt><dd>blocking on the <em>WAKEMIN</em> condition can be an active wait and should be avoided whenever possible.</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">WAKEMAX</td><td>is an expression that is interpreted as an <code>unsigned</code> that should not exceed <a class="el" href="structp99__futex_a926efa02d7a8893ca806f2e8ca977aa9.html#a926efa02d7a8893ca806f2e8ca977aa9" title="the maximum number of waiters that an p99_futex may have">P99_FUTEX_MAX_WAITERS</a>. <em>WAKEMAX</em> is adjusted to be at least as large as <em>WAKEMIN</em>.</td></tr>
  </table>
  </dd>
</dl>
<h3>Example 1: a semaphore implementation</h3>
<p>To see how to use this, let us look into an implementation of a semaphore, starting with a "post" operation.</p>
<ul>
<li>Such a post operation on a semaphore should not place any condition to perform the post action so <em>EXPECTED</em> should always be true.</li>
</ul>
<p>The operation should increment the value by one, so <em>DESIRED</em> should be <code>ACT + 1</code>.</p>
<ul>
<li>It should always wake up potential waiters, so <em>WAKEMAX</em> shouldn't be <code>0</code>.</li>
<li>It should not wake up more than one waiters to avoid the waiters racing for one little token that had been placed. So <em>WAKEMAX</em> should be 1.</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">inline</span></div>
<div class="line"><span class="keywordtype">int</span> my_sem_post(<a class="code" href="structp99__futex.html">p99_futex</a> <span class="keyword">volatile</span>* <a class="code" href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a>) {</div>
<div class="line">  <a class="code" href="structp99__futex_ad22d35b3a2af941a484a6e06a5e46106.html#ad22d35b3a2af941a484a6e06a5e46106">P99_FUTEX_COMPARE_EXCHANGE</a>(<a class="code" href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a>,</div>
<div class="line">                             <span class="comment">// name of the local variable</span></div>
<div class="line">                             val,</div>
<div class="line">                             <span class="comment">// never wait</span></div>
<div class="line">                             <span class="keyword">true</span>,</div>
<div class="line">                             <span class="comment">// increment the value</span></div>
<div class="line">                             val + 1u,</div>
<div class="line">                             <span class="comment">// wake up at most one waiter</span></div>
<div class="line">                             0u, 1u);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>So effectively, such a post operation is just incrementing the value by one and then it up wakes some waiters. In a real world implementation this would better be done by using <a class="el" href="group__futex_ga805fff4efe80ea7e2553f6abf0fd1621.html#ga805fff4efe80ea7e2553f6abf0fd1621" title="increment the counter of p00_fut atomically by p00_hmuch.">p99_futex_add</a>.</p>
<p>A semaphore <em>wait operation</em> should block if the value is <code>0</code>, and then, once the value is positive, decrement that value by <code>1</code> and never wake up any other waiters:</p>
<div class="fragment"><div class="line"><span class="keyword">inline</span></div>
<div class="line"><span class="keywordtype">void</span> my_sem_wait(<a class="code" href="structp99__futex.html">p99_futex</a> <span class="keyword">volatile</span>* <a class="code" href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a>) {</div>
<div class="line">  <a class="code" href="structp99__futex_ad22d35b3a2af941a484a6e06a5e46106.html#ad22d35b3a2af941a484a6e06a5e46106">P99_FUTEX_COMPARE_EXCHANGE</a>(<a class="code" href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a>,</div>
<div class="line">                             <span class="comment">// name of the local variable</span></div>
<div class="line">                             val,</div>
<div class="line">                             <span class="comment">// block if val is 0 and retry</span></div>
<div class="line">                             val &gt; 0,</div>
<div class="line">                             <span class="comment">// once there is val, decrement it, if possible</span></div>
<div class="line">                             val - 1u,</div>
<div class="line">                             <span class="comment">// never wake up anybody</span></div>
<div class="line">                             0u, 0u);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>A semaphore trywait operation should never block, but only decrement the value if it is not <code>0</code>, and never wake up any waiters. A trywait operation must be able to return a value that indicates success or failure of the operation. We set the return value by side effect in the <em>WAKEMIN</em> expression, where we know that it is evaluated only once.</p>
<div class="fragment"><div class="line"><span class="keyword">inline</span></div>
<div class="line"><span class="keywordtype">int</span> my_sem_trywait(<a class="code" href="structp99__futex.html">p99_futex</a> <span class="keyword">volatile</span>* <a class="code" href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a>) {</div>
<div class="line">  <span class="keywordtype">int</span> ret;</div>
<div class="line">  <a class="code" href="structp99__futex_ad22d35b3a2af941a484a6e06a5e46106.html#ad22d35b3a2af941a484a6e06a5e46106">P99_FUTEX_COMPARE_EXCHANGE</a>(<a class="code" href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a>,</div>
<div class="line">                             <span class="comment">// name of the local variable</span></div>
<div class="line">                             val,</div>
<div class="line">                             <span class="comment">// never wait</span></div>
<div class="line">                             <span class="keyword">true</span>,</div>
<div class="line">                             <span class="comment">// if there is val decrement by one</span></div>
<div class="line">                             (val ? 0u : val - 1u),</div>
<div class="line">                             <span class="comment">// capture the error by side effect</span></div>
<div class="line">                             (ret = -!val, 0u),</div>
<div class="line">                             <span class="comment">// never wake up anybody</span></div>
<div class="line">                             0u, 0u);</div>
<div class="line">  <span class="keywordflow">if</span> (ret) <a class="code" href="group__C11__library_ga0a4ccfdbe1cf7b37afc60d34e748b066.html#ga0a4ccfdbe1cf7b37afc60d34e748b066">errno</a> = EAGAIN;</div>
<div class="line">  <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
</div><!-- fragment --><h3>Example 2: reference counting</h3>
<p>Another example of the use of an <a class="el" href="structp99__futex.html" title="A counter similar to a conditional variable that allows atomic increment and decrement and to wait fo...">p99_futex</a> could be a reference counter. Such a counter can e.g be useful to launch a number of threads, and then wait for all the threads to have finished.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> launch_my_threads_detached(<span class="keywordtype">void</span> *arg) {</div>
<div class="line"> <a class="code" href="structp99__futex.html">p99_futex</a>* fut = arg;</div>
<div class="line"> ...</div>
<div class="line"> my_counter_unlock(fut);</div>
<div class="line"> <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code" href="structp99__futex.html">p99_futex</a> fut;</div>
<div class="line"><a class="code" href="group__futex_ga32fa44dd0ab812e0dfdfff658fdd0552.html#ga32fa44dd0ab812e0dfdfff658fdd0552">p99_futex_init</a>(&amp;fut);</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="p99__getopt_8h_a57a586489a0c58f01ad0e9d31e7c2eda.html#a57a586489a0c58f01ad0e9d31e7c2eda">i</a> = 0; <a class="code" href="p99__getopt_8h_a57a586489a0c58f01ad0e9d31e7c2eda.html#a57a586489a0c58f01ad0e9d31e7c2eda">i</a> &lt; large_number; ++<a class="code" href="p99__getopt_8h_a57a586489a0c58f01ad0e9d31e7c2eda.html#a57a586489a0c58f01ad0e9d31e7c2eda">i</a>) {</div>
<div class="line">  my_counter_lock(&amp;fut);</div>
<div class="line">  thrd_t id;</div>
<div class="line">  thrd_create(&amp;<span class="keywordtype">id</span>, launch_my_threads_detached, &amp;fut);</div>
<div class="line">  thrd_detach(<span class="keywordtype">id</span>);</div>
<div class="line">}</div>
<div class="line">...</div>
<div class="line">my_counter_wait(&amp;fut);</div>
</div><!-- fragment --><p>For that scheme to work we just need three "counter" functions. The first just silently piles up references:</p>
<div class="fragment"><div class="line"><span class="keyword">inline</span></div>
<div class="line"><span class="keywordtype">void</span> my_counter_lock(<a class="code" href="structp99__futex.html">p99_futex</a> <span class="keyword">volatile</span>* <a class="code" href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a>) {</div>
<div class="line">  <a class="code" href="structp99__futex_ad22d35b3a2af941a484a6e06a5e46106.html#ad22d35b3a2af941a484a6e06a5e46106">P99_FUTEX_COMPARE_EXCHANGE</a>(<a class="code" href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a>, val, <span class="keyword">true</span>, val + 1u, 0u, 0u);</div>
<div class="line">}</div>
</div><!-- fragment --><p>So effectively, such an operation is just incrementing the value by one. In a real world implementation this would better be done by using ::atomic_fetch_add.</p>
<p>An unlock operation should decrement the value and, if the value falls to <code>0</code>, wake up all waiters:</p>
<div class="fragment"><div class="line"><span class="keyword">inline</span></div>
<div class="line"><span class="keywordtype">void</span> my_counter_unlock_unsafe(<a class="code" href="structp99__futex.html">p99_futex</a> <span class="keyword">volatile</span>* <a class="code" href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a>) {</div>
<div class="line">  <a class="code" href="structp99__futex_ad22d35b3a2af941a484a6e06a5e46106.html#ad22d35b3a2af941a484a6e06a5e46106">P99_FUTEX_COMPARE_EXCHANGE</a>(<a class="code" href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a>,</div>
<div class="line">                             <span class="comment">// name of the local variable</span></div>
<div class="line">                             val,</div>
<div class="line">                             <span class="comment">// never wait</span></div>
<div class="line">                             <span class="keyword">true</span>,</div>
<div class="line">                             <span class="comment">// decrement by one</span></div>
<div class="line">                             val - 1u,</div>
<div class="line">                             <span class="comment">// no enforced wake up</span></div>
<div class="line">                             0u,</div>
<div class="line">                             <span class="comment">// wake up all waiters iff the value falls to 0</span></div>
<div class="line">                             ((val == 1u) ? <a class="code" href="structp99__futex_a926efa02d7a8893ca806f2e8ca977aa9.html#a926efa02d7a8893ca806f2e8ca977aa9">P99_FUTEX_MAX_WAITERS</a> : 0u));</div>
<div class="line">}</div>
</div><!-- fragment --><p>This unsafe version makes no provision for underflow of the counter in case these functions are used erroneously. A safer variant would look like this:</p>
<div class="fragment"><div class="line"><span class="keyword">inline</span></div>
<div class="line"><span class="keywordtype">void</span> my_counter_unlock(<a class="code" href="structp99__futex.html">p99_futex</a> <span class="keyword">volatile</span>* <a class="code" href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a>) {</div>
<div class="line">  <a class="code" href="structp99__futex_ad22d35b3a2af941a484a6e06a5e46106.html#ad22d35b3a2af941a484a6e06a5e46106">P99_FUTEX_COMPARE_EXCHANGE</a>(<a class="code" href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a>, val,</div>
<div class="line">                             <span class="comment">// name of the local variable</span></div>
<div class="line">                             val,</div>
<div class="line">                             <span class="comment">// never wait</span></div>
<div class="line">                             <span class="keyword">true</span>,</div>
<div class="line">                             <span class="comment">// decrement by one, but only if wouldn&#39;t be underflow</span></div>
<div class="line">                             (val ? val - 1u : 0u),</div>
<div class="line">                             <span class="comment">// no enforced wake up</span></div>
<div class="line">                             0u,</div>
<div class="line">                             <span class="comment">// wake up all waiters iff the new value is 0</span></div>
<div class="line">                             ((val &lt;= 1u) ? <a class="code" href="structp99__futex_a926efa02d7a8893ca806f2e8ca977aa9.html#a926efa02d7a8893ca806f2e8ca977aa9">P99_FUTEX_MAX_WAITERS</a> : 0u));</div>
<div class="line">}</div>
</div><!-- fragment --><p>A wait operation should just expect the counter to fall to <code>0</code> and do not much else.</p>
<div class="fragment"><div class="line"><span class="keyword">inline</span></div>
<div class="line"><span class="keywordtype">void</span> my_counter_wait(<a class="code" href="structp99__futex.html">p99_futex</a> <span class="keyword">volatile</span>* <a class="code" href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a>) {</div>
<div class="line">  <a class="code" href="structp99__futex_ad22d35b3a2af941a484a6e06a5e46106.html#ad22d35b3a2af941a484a6e06a5e46106">P99_FUTEX_COMPARE_EXCHANGE</a>(<a class="code" href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a>, val, 0u, 0u, 0u);</div>
<div class="line">                             <span class="comment">// name of the local variable</span></div>
<div class="line">                             val,</div>
<div class="line">                             <span class="comment">// wait until the value is 0</span></div>
<div class="line">                             !val,</div>
<div class="line">                             <span class="comment">// don&#39;t do anything else, no update</span></div>
<div class="line">                             0u,</div>
<div class="line">                             <span class="comment">// and no wake up</span></div>
<div class="line">                             0u, 0u);</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section remark"><dt>Remarks</dt><dd>argument 1 must be an identifier </dd></dl>

<p class="definition">Definition at line <a class="el" href="p99__futex_8h_source.html#l00563">563</a> of file <a class="el" href="p99__futex_8h_source.html">p99_futex.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="group__futex_ga6c33d95cc912a14baaf14fcf51b61f79.html#ga6c33d95cc912a14baaf14fcf51b61f79">p99_cm::p99_cm_lock()</a>, <a class="el" href="group__futex_gac3ff44e3c10e715562bde8c625002565.html#gac3ff44e3c10e715562bde8c625002565">p99_count::p99_count_wait()</a>, <a class="el" href="group__futex_gad5f0a00589913dce16413370e197b6d4.html#gad5f0a00589913dce16413370e197b6d4">p99_iterator::p99_iterator_next()</a>, <a class="el" href="group__futex_ga7da4887d51f589428b6fd92ce5d56091.html#ga7da4887d51f589428b6fd92ce5d56091">p99_notifier::p99_notifier_block()</a>, <a class="el" href="group__futex_ga7305c16cd446881a1bec6c221f63ed63.html#ga7305c16cd446881a1bec6c221f63ed63">p99_rwl::p99_rwl_rdlock()</a>, <a class="el" href="group__futex_gae9983a9a31bf9e9b3563761866f12f49.html#gae9983a9a31bf9e9b3563761866f12f49">p99_rwl::p99_rwl_unlock()</a>, and <a class="el" href="group__futex_ga9753ebf2bbae3bc88ebaa9feb2a27759.html#ga9753ebf2bbae3bc88ebaa9feb2a27759">p99_rwl::p99_rwl_wrlock()</a>.</p>

</div>
</div>
    </td>
  </tr>
</table>
</div><!-- contents -->
<div class="ttc" id="astructp99__futex_html"><div class="ttname"><a href="structp99__futex.html">p99_futex</a></div><div class="ttdoc">A counter similar to a conditional variable that allows atomic increment and decrement and to wait fo...</div><div class="ttdef"><b>Definition:</b> <a href="p99__futex_8h_source.html#l00163">p99_futex.h:163</a></div></div>
<div class="ttc" id="ap99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31_html_a633de4b0c14ca52ea2432a3c8a5c4c31"><div class="ttname"><a href="p99__str_8h_a633de4b0c14ca52ea2432a3c8a5c4c31.html#a633de4b0c14ca52ea2432a3c8a5c4c31">f</a></div><div class="ttdeci">f</div><div class="ttdef"><b>Definition:</b> <a href="p99__str_8h_source.html#l00138">p99_str.h:138</a></div></div>
<div class="ttc" id="astructp99__futex_ad22d35b3a2af941a484a6e06a5e46106_html_ad22d35b3a2af941a484a6e06a5e46106"><div class="ttname"><a href="structp99__futex_ad22d35b3a2af941a484a6e06a5e46106.html#ad22d35b3a2af941a484a6e06a5e46106">p99_futex::P99_FUTEX_COMPARE_EXCHANGE</a></div><div class="ttdeci">#define P99_FUTEX_COMPARE_EXCHANGE(FUTEX, ACT, EXPECTED, DESIRED, WAKEMIN, WAKEMAX)</div><div class="ttdoc">a catch all macro to operate on p99_futex</div><div class="ttdef"><b>Definition:</b> <a href="p99__futex_8h_source.html#l00563">p99_futex.h:563</a></div></div>
<div class="ttc" id="astructp99__futex_a926efa02d7a8893ca806f2e8ca977aa9_html_a926efa02d7a8893ca806f2e8ca977aa9"><div class="ttname"><a href="structp99__futex_a926efa02d7a8893ca806f2e8ca977aa9.html#a926efa02d7a8893ca806f2e8ca977aa9">p99_futex::P99_FUTEX_MAX_WAITERS</a></div><div class="ttdeci">#define P99_FUTEX_MAX_WAITERS</div><div class="ttdoc">the maximum number of waiters that an p99_futex may have</div><div class="ttdef"><b>Definition:</b> <a href="p99__futex_8h_source.html#l00178">p99_futex.h:178</a></div></div>
<div class="ttc" id="ap99__getopt_8h_a57a586489a0c58f01ad0e9d31e7c2eda_html_a57a586489a0c58f01ad0e9d31e7c2eda"><div class="ttname"><a href="p99__getopt_8h_a57a586489a0c58f01ad0e9d31e7c2eda.html#a57a586489a0c58f01ad0e9d31e7c2eda">i</a></div><div class="ttdeci">P00_CLAUSE2 i(_Pragma(&quot;weak  p00_getopt_comp&quot;))(_Pragma(&quot;weak p00_getopt_comp </div></div>
<div class="ttc" id="agroup__futex_ga32fa44dd0ab812e0dfdfff658fdd0552_html_ga32fa44dd0ab812e0dfdfff658fdd0552"><div class="ttname"><a href="group__futex_ga32fa44dd0ab812e0dfdfff658fdd0552.html#ga32fa44dd0ab812e0dfdfff658fdd0552">p99_futex::p99_futex_init</a></div><div class="ttdeci">p99_futex * p99_futex_init(p99_futex *p00_c, unsigned p00_ini)</div><div class="ttdoc">Initialize an p99_futex object.</div></div>
<div class="ttc" id="agroup__C11__library_ga0a4ccfdbe1cf7b37afc60d34e748b066_html_ga0a4ccfdbe1cf7b37afc60d34e748b066"><div class="ttname"><a href="group__C11__library_ga0a4ccfdbe1cf7b37afc60d34e748b066.html#ga0a4ccfdbe1cf7b37afc60d34e748b066">errno</a></div><div class="ttdeci">errno</div><div class="ttdef"><b>Definition:</b> <a href="p99__constraint_8h_source.html#l00199">p99_constraint.h:199</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
