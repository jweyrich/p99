<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>P99: P99_UNWIND_PROTECT</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">P99
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="group__preprocessor__blocks.html">Preprocessor Blocks</a></li>  </ul>
</div>
</div><!-- top -->
<div class="contents">
<table cellspacing="0" cellpadding="0" border="0">
  <tr>
   <td valign="top">
      <div class="navtab">
        <table>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_gacdcdbf020344038c9fa0de0a7d8fb7ec.html#gacdcdbf020344038c9fa0de0a7d8fb7ec">for</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_ga5ad3c18edd11e4b0acf86496046b3f21.html#ga5ad3c18edd11e4b0acf86496046b3f21">P99_BLK_MARK</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_ga4e4a33f799d068aaebe28fbeebf7e8f5.html#ga4e4a33f799d068aaebe28fbeebf7e8f5">P99_BLOCK_DOCUMENT</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_ga1757e648f90237ca4a9c8f6562c2a745.html#ga1757e648f90237ca4a9c8f6562c2a745">P99_CASERANGE</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_ga41d6ee07b6d45361720a01e1064bd435.html#ga41d6ee07b6d45361720a01e1064bd435">P99_DO</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_gaa617d014eeeaa561e1ff063b2014df83.html#gaa617d014eeeaa561e1ff063b2014df83">P99_FORALL</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_gaa864200ae44c5666b1c42cfa60836a63.html#gaa864200ae44c5666b1c42cfa60836a63">P99_GUARDED_BLOCK</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_gab77c2a48f5449cc7935dbb2437b00e67.html#gab77c2a48f5449cc7935dbb2437b00e67">P99_HANDLE_ERRNO</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_gaed18105bafd193ace796a59fd33107ef.html#gaed18105bafd193ace796a59fd33107ef">P99_INVARIANT</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_gaacff75cd15a1dd11138fdeeb91a3f677.html#gaacff75cd15a1dd11138fdeeb91a3f677">P99_MARK</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_ga4e33c35ae91484a4483705b4c45277b9.html#ga4e33c35ae91484a4483705b4c45277b9">P99_NOP</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_ga966baf107822e22a4bbce453b6d7f3a7.html#ga966baf107822e22a4bbce453b6d7f3a7">P99_PARALLEL_DO</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_gaaedc09a65ee738c4902e8c1bf8e415fb.html#gaaedc09a65ee738c4902e8c1bf8e415fb">P99_PARALLEL_FOR</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_gadc2bef2dceeff9802aeb2ce5254876b0.html#gadc2bef2dceeff9802aeb2ce5254876b0">P99_PARALLEL_FORALL</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_ga924384d101d6a1e004ceb41dd7220d91.html#ga924384d101d6a1e004ceb41dd7220d91">P99_PROTECT</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_ga2eaeb00e774c19d9fe5a86f8e114e583.html#ga2eaeb00e774c19d9fe5a86f8e114e583">P99_PROTECTED_BLOCK</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_ga2b2f7c0df0dd3b4836f5c0acfb163885.html#ga2b2f7c0df0dd3b4836f5c0acfb163885">P99_SIMPLE_BLOCKS</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_ga81fa4f2d3128c004d8920cf031cc0369.html#ga81fa4f2d3128c004d8920cf031cc0369">P99_UNCASE</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_ga7aaa0ac4082af4f1597f39ef1c32e1bd.html#ga7aaa0ac4082af4f1597f39ef1c32e1bd">p99_unwind</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_ga81698cb1303c3cb1551652098cbe72ef.html#ga81698cb1303c3cb1551652098cbe72ef">P99_UNWIND</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_ga18ecf54f2b57d1c1b41cdb5168f3e871.html#ga18ecf54f2b57d1c1b41cdb5168f3e871">p99_unwind_code</a></td></tr>
          <tr><td class="navtab"><a class="qindexHL" href="group__preprocessor__blocks_ga3a751607e9ac837ee9c95efbaac5721f.html#ga3a751607e9ac837ee9c95efbaac5721f">P99_UNWIND_PROTECT</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="group__preprocessor__blocks_ga437feef97b20e9cbdc3ab446826caf1b.html#ga437feef97b20e9cbdc3ab446826caf1b">P99_UNWIND_RETURN</a></td></tr>
        </table>
      </div>
   </td>
   <td valign="top" class="mempage">
<a id="ga3a751607e9ac837ee9c95efbaac5721f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga3a751607e9ac837ee9c95efbaac5721f">&#9670;&nbsp;</a></span>P99_UNWIND_PROTECT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define P99_UNWIND_PROTECT</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Unwind execution from several levels of nesting inside a function. </p>
<p>This macro allows several levels of block statements to be unwound safely.</p>
<div class="fragment"><div class="line"><a class="code" href="group__preprocessor__blocks_ga3a751607e9ac837ee9c95efbaac5721f.html#ga3a751607e9ac837ee9c95efbaac5721f">P99_UNWIND_PROTECT</a> {</div>
<div class="line">  <span class="comment">// do something</span></div>
<div class="line">  <span class="keywordflow">while</span> (cond0) {</div>
<div class="line">    <span class="keywordflow">for</span> (;cond1;) {</div>
<div class="line">       <span class="keywordflow">if</span> (cond2) <a class="code" href="group__preprocessor__blocks_ga81698cb1303c3cb1551652098cbe72ef.html#ga81698cb1303c3cb1551652098cbe72ef">P99_UNWIND</a>(-1);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> <a class="code" href="group__preprocessor__blocks_ga924384d101d6a1e004ceb41dd7220d91.html#ga924384d101d6a1e004ceb41dd7220d91">P99_PROTECT</a> :</div>
<div class="line">  <span class="comment">// do some cleanup here</span></div>
<div class="line">  <span class="comment">// if everything went well ::p99_unwind_code has value 0 otherwise it</span></div>
<div class="line">  <span class="comment">// receives a value from P99_UNWIND</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>Here <a class="el" href="group__preprocessor__blocks_ga81698cb1303c3cb1551652098cbe72ef.html#ga81698cb1303c3cb1551652098cbe72ef" title="Preliminary resume from one or several levels of nested P99_UNWIND_PROTECT.">P99_UNWIND</a> terminates the execution of the inner blocks and resumes execution at the special "label" <a class="el" href="group__preprocessor__blocks_ga924384d101d6a1e004ceb41dd7220d91.html#ga924384d101d6a1e004ceb41dd7220d91" title="The pseudo label to which we jump when we unwind the stack with P99_UNWIND.">P99_PROTECT</a>, if present.</p>
<p>The argument to <a class="el" href="group__preprocessor__blocks_ga81698cb1303c3cb1551652098cbe72ef.html#ga81698cb1303c3cb1551652098cbe72ef" title="Preliminary resume from one or several levels of nested P99_UNWIND_PROTECT.">P99_UNWIND</a> controls how many levels are unwound. If it is positive, at most the specified number of levels is unwound, but never more levels than there are on the call stack of the enclosing function. If it is negative, all levels on the stack of the enclosing function are unwound and during unwinding, this negative argument (that was passed to <a class="el" href="group__preprocessor__blocks_ga81698cb1303c3cb1551652098cbe72ef.html#ga81698cb1303c3cb1551652098cbe72ef" title="Preliminary resume from one or several levels of nested P99_UNWIND_PROTECT.">P99_UNWIND</a>) is accessible through <a class="el" href="group__preprocessor__blocks_ga18ecf54f2b57d1c1b41cdb5168f3e871.html#ga18ecf54f2b57d1c1b41cdb5168f3e871" title="The code an eventual call to P99_UNWIND.">p99_unwind_code</a>.</p>
<dl class="section warning"><dt>Warning</dt><dd>Variables that are modified before the call to <a class="el" href="group__preprocessor__blocks_ga81698cb1303c3cb1551652098cbe72ef.html#ga81698cb1303c3cb1551652098cbe72ef" title="Preliminary resume from one or several levels of nested P99_UNWIND_PROTECT.">P99_UNWIND</a> are only guaranteed to have their new value in the protected part if they are declared <code>volatile</code>.</dd></dl>
<p>Let us see this at an example. The natural way with <a class="el" href="group__preprocessor__blocks_ga3a751607e9ac837ee9c95efbaac5721f.html#ga3a751607e9ac837ee9c95efbaac5721f" title="Unwind execution from several levels of nesting inside a function.">P99_UNWIND_PROTECT</a> to check for a valid return of <code>malloc</code> could look like this:</p>
<div class="fragment"><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*<span class="keyword">volatile</span> buffer = 0;</div>
<div class="line"><a class="code" href="group__preprocessor__blocks_ga3a751607e9ac837ee9c95efbaac5721f.html#ga3a751607e9ac837ee9c95efbaac5721f">P99_UNWIND_PROTECT</a> {</div>
<div class="line">  buffer = malloc(bignumber);</div>
<div class="line">  <span class="keywordflow">if</span> (!buffer || IamSick) <a class="code" href="group__preprocessor__blocks_ga81698cb1303c3cb1551652098cbe72ef.html#ga81698cb1303c3cb1551652098cbe72ef">P99_UNWIND</a> 1;</div>
<div class="line">  <span class="comment">// do something complicated with buffer</span></div>
<div class="line"><a class="code" href="group__preprocessor__blocks_ga924384d101d6a1e004ceb41dd7220d91.html#ga924384d101d6a1e004ceb41dd7220d91">P99_PROTECT</a>:</div>
<div class="line">  free(buffer);</div>
<div class="line">}</div>
</div><!-- fragment --><p>If we would not declare <code>buffer</code> to be <code>volatile</code>, the update to <code>buffer</code> with the new value would perhaps not be visible at the point that we call <code>free</code>. Under normal circumstance the compiler is allowed to optimize the store operation away (implied by the assignment), if he can prove that the only visible value of it comes from the last assignment. I could then just use a cached value (e.g in a register) to pass as an argument to <code>free</code>. The <code>volatile</code> qualifier inhibits such an optimization and forces memory-store operations when there is a modification and memory-load operations when there is access to the variable.</p>
<dl class="section warning"><dt>Warning</dt><dd>There should be no plain <code>return</code> statement in the depending block before the <a class="el" href="group__preprocessor__blocks_ga924384d101d6a1e004ceb41dd7220d91.html#ga924384d101d6a1e004ceb41dd7220d91" title="The pseudo label to which we jump when we unwind the stack with P99_UNWIND.">P99_PROTECT</a> label.</dd></dl>
<dl class="section see"><dt>See also</dt><dd>"test-p99-block.c" <a class="el" href="group__preprocessor__blocks_gacdcdbf020344038c9fa0de0a7d8fb7ec.html#gacdcdbf020344038c9fa0de0a7d8fb7ec" title="Prefer the statements in the argument list over the statement or block that follows.">for</a> a more sophisticated example of nested <a class="el" href="group__preprocessor__blocks_ga3a751607e9ac837ee9c95efbaac5721f.html#ga3a751607e9ac837ee9c95efbaac5721f" title="Unwind execution from several levels of nesting inside a function.">P99_UNWIND_PROTECT</a>. </dd>
<dd>
<a class="el" href="group__preprocessor__blocks_ga81698cb1303c3cb1551652098cbe72ef.html#ga81698cb1303c3cb1551652098cbe72ef" title="Preliminary resume from one or several levels of nested P99_UNWIND_PROTECT.">P99_UNWIND</a> </dd>
<dd>
<a class="el" href="group__preprocessor__blocks_ga437feef97b20e9cbdc3ab446826caf1b.html#ga437feef97b20e9cbdc3ab446826caf1b" title="Return from the enclosing function after unwinding all levels of nested P99_UNWIND_PROTECT.">P99_UNWIND_RETURN</a> <a class="el" href="group__preprocessor__blocks_gacdcdbf020344038c9fa0de0a7d8fb7ec.html#gacdcdbf020344038c9fa0de0a7d8fb7ec" title="Prefer the statements in the argument list over the statement or block that follows.">for</a> a replacement of <code>return</code> that respects the protected parts </dd>
<dd>
<a class="el" href="group__validity_ga44181dc93ca0663ffde886682e5e706f.html#ga44181dc93ca0663ffde886682e5e706f" title="Insert code checks for bare return statements inside P99_UNWIND_PROTECT.">P99_CHECK_RETURN</a> to check <a class="el" href="group__preprocessor__blocks_gacdcdbf020344038c9fa0de0a7d8fb7ec.html#gacdcdbf020344038c9fa0de0a7d8fb7ec" title="Prefer the statements in the argument list over the statement or block that follows.">for</a> suspicious bare <code>return</code> statements </dd>
<dd>
<a class="el" href="group__preprocessor__blocks_ga18ecf54f2b57d1c1b41cdb5168f3e871.html#ga18ecf54f2b57d1c1b41cdb5168f3e871" title="The code an eventual call to P99_UNWIND.">p99_unwind_code</a> </dd>
<dd>
<a class="el" href="group__preprocessor__blocks_ga7aaa0ac4082af4f1597f39ef1c32e1bd.html#gga7aaa0ac4082af4f1597f39ef1c32e1bda71bbaface54ccdb11bcf7e3b40baca30" title="The level of nesting P99_UNWIND_PROTECT.">p99_unwind_level</a> </dd>
<dd>
<a class="el" href="group__try_ga9162d721fecf634c028ab873912c9cd0.html#ga9162d721fecf634c028ab873912c9cd0" title="Create a block that can catch exceptions.">P99_TRY</a> and <a class="el" href="group__try_ga9362aa9665b1657c14414676c4e3b63c.html#ga9362aa9665b1657c14414676c4e3b63c" title="Stop execution at the current point and signal an exception of value X to the next P99_TRY clause on ...">P99_THROW</a> <a class="el" href="group__preprocessor__blocks_gacdcdbf020344038c9fa0de0a7d8fb7ec.html#gacdcdbf020344038c9fa0de0a7d8fb7ec" title="Prefer the statements in the argument list over the statement or block that follows.">for</a> a construct that can be used across function calls. </dd></dl>

<p class="definition">Definition at line <a class="el" href="p99__block_8h_source.html#l00612">612</a> of file <a class="el" href="p99__block_8h_source.html">p99_block.h</a>.</p>

</div>
</div>
    </td>
  </tr>
</table>
</div><!-- contents -->
<div class="ttc" id="agroup__preprocessor__blocks_ga924384d101d6a1e004ceb41dd7220d91_html_ga924384d101d6a1e004ceb41dd7220d91"><div class="ttname"><a href="group__preprocessor__blocks_ga924384d101d6a1e004ceb41dd7220d91.html#ga924384d101d6a1e004ceb41dd7220d91">P99_PROTECT</a></div><div class="ttdeci">#define P99_PROTECT</div><div class="ttdoc">The pseudo label to which we jump when we unwind the stack with P99_UNWIND.</div><div class="ttdef"><b>Definition:</b> <a href="p99__block_8h_source.html#l00719">p99_block.h:719</a></div></div>
<div class="ttc" id="agroup__preprocessor__blocks_ga81698cb1303c3cb1551652098cbe72ef_html_ga81698cb1303c3cb1551652098cbe72ef"><div class="ttname"><a href="group__preprocessor__blocks_ga81698cb1303c3cb1551652098cbe72ef.html#ga81698cb1303c3cb1551652098cbe72ef">P99_UNWIND</a></div><div class="ttdeci">#define P99_UNWIND(X)</div><div class="ttdoc">Preliminary resume from one or several levels of nested P99_UNWIND_PROTECT.</div><div class="ttdef"><b>Definition:</b> <a href="p99__block_8h_source.html#l00664">p99_block.h:664</a></div></div>
<div class="ttc" id="agroup__preprocessor__blocks_ga3a751607e9ac837ee9c95efbaac5721f_html_ga3a751607e9ac837ee9c95efbaac5721f"><div class="ttname"><a href="group__preprocessor__blocks_ga3a751607e9ac837ee9c95efbaac5721f.html#ga3a751607e9ac837ee9c95efbaac5721f">P99_UNWIND_PROTECT</a></div><div class="ttdeci">#define P99_UNWIND_PROTECT</div><div class="ttdoc">Unwind execution from several levels of nesting inside a function.</div><div class="ttdef"><b>Definition:</b> <a href="p99__block_8h_source.html#l00612">p99_block.h:612</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
