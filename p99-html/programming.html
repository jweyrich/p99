<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>P99: Macro programming with P99</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">P99
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Macro programming with P99 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Most macros and features for macro programming with P99 are defined in <a class="el" href="group__meta__programming.html">Meta_programming</a>. This allows operations such as </p><dl>
<dt><a class="el" href="programming.html#arg_counting">Argument List Counting</a> </dt>
<dd></dd>
<dt>rudimentary argument list processing </dt>
<dd>to obtain e.g a sublist of the argument list (<a class="el" href="group__basic__list__operations_ga36a4ab24ad412a94da4c5aad433d6cd3.html#ga36a4ab24ad412a94da4c5aad433d6cd3" title="Return the length of the variable length argument list, where an empty argument list is considered to...">P99_NARG</a>) or revert an argument (<a class="el" href="group__preprocessor__for_ga7ce820b215664fea1c4ff1cdb8079728.html#ga7ce820b215664fea1c4ff1cdb8079728" title="Revert the argument list.">P99_REVS</a>) </dd>
<dt><a class="el" href="programming.html#unrolling">Code Unrolling</a> </dt>
<dd>not restricted to usual <code>for</code> loops but also e.g to produce a sequence of declarations with initializers (<a class="el" href="group__statement__lists_ga8b50ee12a4f501f1701cbeebf4c5e698.html#ga8b50ee12a4f501f1701cbeebf4c5e698" title="Vector-assign to a list.">P99_VASSIGNS</a>) </dd>
<dt>constant generation </dt>
<dd>to compose <code>double</code> constants </dd>
<dt>type and keyword classification </dt>
<dd></dd>
<dt><a class="el" href="utilities.html#blocks">Scope-bound resource management with for-statements</a> </dt>
<dd></dd>
</dl>
<h1><a class="anchor" id="arg_counting"></a>
Argument List Counting</h1>
<p>To implement macros in which evaluation depends upon the number of arguments received, we will need to determine how many arguments are received. This can be achieved with something like the following:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define P00_ARG2(_0, _1, _2, ...) _2</span></div>
<div class="line"><span class="preprocessor">#define NARG2(...) P00_ARG2(__VA_ARGS__, 2, 1, 0)</span></div>
</div><!-- fragment --><p>If NARG2 is called with two arguments the <code>2</code> of its expansion is in third position and we will see this <code>2</code>. If it is called with just one argument the 1 will be in that place and thus be the result of the expansion. You can probably imagine an extension of that macro to treat more arguments, look into the P99 sources to see a version for <a class="el" href="p99__generated_8h_a1d1df64eabc7e929e4d4c37f21f98557.html#a1d1df64eabc7e929e4d4c37f21f98557" title="The maximal number of arguments the P99 macros can handle.">P99_MAX_NUMBER</a>.</p>
<p>The toy macro <code>NARG2</code> has an important property, namely that it swallows <em>all</em> its arguments when called correctly (say with 0, 1 or 2 arguments) and just returns a token that corresponds to the number. Such a property is important for macro programming since we don't want to have the compiler itself see the same expressions multiple times.</p>
<p>The <code>NARG2</code> has a major disadvantage: it is unable to detect an empty argument list. This is due to a fundamental difference between C and its preprocessor. For C, a parenthesis <code></code>() is empty and contains no argument. For the preprocessor it contains just one argument, and this argument is the empty token <code>&#160;</code>.</p>
<p>So in fact <code>NARG2</code> cheats. It doesn't count the number of arguments that it receives, but returns the number of commas plus one. In particular, even if it receives an empty argument list it will return <code>1</code>. The macro <a class="el" href="group__basic__list__operations_ga36a4ab24ad412a94da4c5aad433d6cd3.html#ga36a4ab24ad412a94da4c5aad433d6cd3" title="Return the length of the variable length argument list, where an empty argument list is considered to...">P99_NARG</a> deals with that and returns the token <code>0</code>, if the list is empty.</p>
<p>Other macros are then programmed with similar tricks as are used for <code>NARG2</code>, here: the variable argument list is positioned at the beginning of a new macro list that is then completed by a list of values that contain the different tokens that complete the given list, if necessary.</p>
<p>A second trick is then to paste the name of another macro with that number together. Look e.g at <a class="el" href="group__basic__list__operations_ga092c88edc2908df47da55cf882775b67.html#ga092c88edc2908df47da55cf882775b67" title="Construct a list that repeats the argument list N times.">P99_DUPL</a>. When called as follows</p>
<div class="fragment"><div class="line">(<a class="code" href="group__basic__list__operations_ga092c88edc2908df47da55cf882775b67.html#ga092c88edc2908df47da55cf882775b67">P99_DUPL</a>(3, A))  ==&gt; (P00_DUPL3(A))</div>
</div><!-- fragment --><p>this then is replaced <a class="el" href="footnotes.html"><sup> 4</sup></a> as follow </p><div class="fragment"><div class="line">(P00_DUPL3(A)) ==&gt; (A, P00_DUPL2(A)) ==&gt; (A, A, P00_DUPL1(A)) ==&gt; (A, A, A)</div>
</div><!-- fragment --><p>The example of <a class="el" href="group__basic__list__operations_ga092c88edc2908df47da55cf882775b67.html#ga092c88edc2908df47da55cf882775b67" title="Construct a list that repeats the argument list N times.">P99_DUPL</a> together with ::P00_DUPL1, ... in file <a class="el" href="p99__generated_8h.html" title="automatically generated macros to handle variadic macros.">p99_generated.h</a> shows a general strategy to overcome the lack of control structures or recursion in the preprocessor. But generally it would be tedious and error prone to have to copy similar definitions over and over again. Therefore P99 implements some of these with a script and collects them in the above mentioned include file. This is probably not something you should do yourself. Section <a class="el" href="programming.html#unrolling">Code Unrolling</a> will show how to avoid this with higher level preprocessor programming constructs.</p>
<p>The next step in macro programming is then to use <a class="el" href="group__basic__list__operations_ga36a4ab24ad412a94da4c5aad433d6cd3.html#ga36a4ab24ad412a94da4c5aad433d6cd3" title="Return the length of the variable length argument list, where an empty argument list is considered to...">P99_NARG</a> to obtain the length of a list and to use this numeric token to derive a macro name with the number in it</p>
<div class="fragment"><div class="line"><a class="code" href="group__preprocessor__text_ga39f23a9e2f85305255b89cb671f39067.html#ga39f23a9e2f85305255b89cb671f39067">P99_PASTE</a>(t, o, k, e, n)</div>
<div class="line">==&gt;</div>
<div class="line">P00_PASTE(P00_NARG(t, o, k, e, n), t, o, k, e, n)</div>
<div class="line">==&gt;</div>
<div class="line">P00_PASTE(5, t, o, k, e, n)</div>
<div class="line">==&gt;</div>
<div class="line">P00__PASTE(<a class="code" href="group__preprocessor__text_ga39f23a9e2f85305255b89cb671f39067.html#ga39f23a9e2f85305255b89cb671f39067">P99_PASTE</a>, 5, t, o, k, e, n)</div>
<div class="line">==&gt;</div>
<div class="line"><a class="code" href="group__preprocessor__text_ga39f23a9e2f85305255b89cb671f39067.html#ga39f23a9e2f85305255b89cb671f39067">P99_PASTE</a> ## 5(t, o, k, e, n)</div>
<div class="line">==&gt;</div>
<div class="line"><a class="code" href="group__preprocessor__text_ga06c6175eb9c536da94dcbb3f985a8f45.html#ga06c6175eb9c536da94dcbb3f985a8f45">P99_PASTE5</a>(t, o, k, e, n)</div>
<div class="line">==&gt;</div>
<div class="line">.</div>
<div class="line">==&gt;</div>
<div class="line">token</div>
</div><!-- fragment --><dl class="footnotes"><dt><b><a class="el" href="footnotes.html#_footnotes000003">Footnotes:</a></b></dt><dd><sup> 4 </sup> The actual definition is a bit more complicated to capture special cases.</dd></dl>
<h1><a class="anchor" id="unrolling"></a>
Code Unrolling</h1>
<p>Code unrolling is a generalization of what classicaly would be left to the compiler (and not the preprocessor): loop unrolling. Suppose that in some context you have a loop of fixed length</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <a class="code" href="p99__getopt_8h_a57a586489a0c58f01ad0e9d31e7c2eda.html#a57a586489a0c58f01ad0e9d31e7c2eda">i</a> = 0; <a class="code" href="p99__getopt_8h_a57a586489a0c58f01ad0e9d31e7c2eda.html#a57a586489a0c58f01ad0e9d31e7c2eda">i</a> &lt; 4; ++<a class="code" href="p99__getopt_8h_a57a586489a0c58f01ad0e9d31e7c2eda.html#a57a586489a0c58f01ad0e9d31e7c2eda">i</a>)</div>
<div class="line">   a[<a class="code" href="p99__getopt_8h_a57a586489a0c58f01ad0e9d31e7c2eda.html#a57a586489a0c58f01ad0e9d31e7c2eda">i</a>] = b[<a class="code" href="p99__getopt_8h_a57a586489a0c58f01ad0e9d31e7c2eda.html#a57a586489a0c58f01ad0e9d31e7c2eda">i</a>];</div>
</div><!-- fragment --><p>There is a good chance that an optimizing compiler would unroll this loop</p>
<div class="fragment"><div class="line">a[0] = b[0];</div>
<div class="line">a[1] = b[1];</div>
<div class="line">a[2] = b[2];</div>
<div class="line">a[3] = b[3];</div>
</div><!-- fragment --><p>This would have the advantage to spare a CPU register otherwise used for <code>i</code> and also that the addressing of the individual elements now can be done with constant offsets from the basepointers of <code>a</code> and <code>b</code>.</p>
<p>We will see below how to achieve such loop unrolling directly with the preprocessor, avoiding reliance on the compiler.</p>
<p>But code unrolling can do more than that. It may be helpful where we have repeated pieces of code for which there is no loop construct in C, for example in a declaration: </p><div class="fragment"><div class="line"><span class="keywordtype">signed</span> a[4] = { b[0], b[1], b[2], b[3] };</div>
</div><!-- fragment --><p>With P99 you can write this simply as </p><div class="fragment"><div class="line"><span class="keywordtype">signed</span> a[4] = { <a class="code" href="group__statement__lists_ga44356c23b76dc02e22487ba2f532dc39.html#ga44356c23b76dc02e22487ba2f532dc39">P99_ACCESSORS</a>(b, 4) };</div>
</div><!-- fragment --><p>If the length of your vectors might perhaps change during the development of your program, you can have the length of the array as a compile time parameter </p><div class="fragment"><div class="line"><span class="preprocessor">#define N 4</span></div>
<div class="line">.</div>
<div class="line">signed a[N] = { <a class="code" href="group__statement__lists_ga44356c23b76dc02e22487ba2f532dc39.html#ga44356c23b76dc02e22487ba2f532dc39">P99_ACCESSORS</a>(b, N) };</div>
</div><!-- fragment --><p>You'd later just change <code>N</code> and the rest of your code remains consistent.</p>
<p>As another example of flexibility take another assignment example, namely the "deserialization" of a <code>struct</code>. Suppose that we have a variable of a <code>struct</code> type to which we want to assign values that we receive through an array <code>b:</code> </p><div class="fragment"><div class="line">A.x = b[0];</div>
<div class="line">A.y0 = b[1];</div>
<div class="line">A.o7 = b[2];</div>
<div class="line">A.k = b[3];</div>
</div><!-- fragment --><p>Here the pattern is somewhat regular, you assign the elements of <code>b</code> in order, but the left hand sides are arbitrary. P99 can do that for you </p><div class="fragment"><div class="line"><a class="code" href="group__statement__lists_ga8b50ee12a4f501f1701cbeebf4c5e698.html#ga8b50ee12a4f501f1701cbeebf4c5e698">P99_VASSIGNS</a>(b, A.x, A.y0, A.o7, A.k);</div>
</div><!-- fragment --><p>BTW, with the two P99 macros that we just introduced we can now perform the loop unrolling from the beginning: </p><div class="fragment"><div class="line"><a class="code" href="group__statement__lists_ga8b50ee12a4f501f1701cbeebf4c5e698.html#ga8b50ee12a4f501f1701cbeebf4c5e698">P99_VASSIGNS</a>(b, <a class="code" href="group__statement__lists_ga44356c23b76dc02e22487ba2f532dc39.html#ga44356c23b76dc02e22487ba2f532dc39">P99_ACCESSORS</a>(a, 4));</div>
</div><!-- fragment --><p>The "control structure" that is behind these two macros is called <a class="el" href="group__preprocessor__for_gae3eb0e3a5216300874ed6cb9abc170ce.html#gae3eb0e3a5216300874ed6cb9abc170ce" title="A preprocessor pseudo iterator.">P99_FOR</a>. This is by itself a macro that takes at least 4 parameters, named <code>NAME</code>, <code>N</code>, <code>OP</code>, <code>FUNC</code>, but generally will have more, namely a list <code>A0, A1, ... , A{N-1}</code> of extra arguments. The idea behind this is simple:</p><ul>
<li>the argument <code>FUNC</code> is supposed to be a macro name that is going to be applied to each of the <code>A{i}</code> </li>
<li>argument <code>OP</code> in turn is a macro that is called to control the "glue" between the different occurrences of the <code>FUNC</code> invocations.</li>
</ul>
<p>An example of <code>FUNC</code> would be something like <code>NAME[i]</code> for an accessor. For <code>OP</code> we provide simple choices as ::P00_SEQ which just puts commas between the occurrences or ::P00_SEP to do so with semicolons. For more exact examples and the syntax for <code>OP</code> and <code>FUNC</code> please refer to the documentation of <a class="el" href="group__preprocessor__for_gae3eb0e3a5216300874ed6cb9abc170ce.html#gae3eb0e3a5216300874ed6cb9abc170ce" title="A preprocessor pseudo iterator.">P99_FOR</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="agroup__statement__lists_ga44356c23b76dc02e22487ba2f532dc39_html_ga44356c23b76dc02e22487ba2f532dc39"><div class="ttname"><a href="group__statement__lists_ga44356c23b76dc02e22487ba2f532dc39.html#ga44356c23b76dc02e22487ba2f532dc39">P99_ACCESSORS</a></div><div class="ttdeci">#define P99_ACCESSORS(X, N)</div><div class="ttdef"><b>Definition:</b> <a href="p99__map_8h_source.html#l00199">p99_map.h:199</a></div></div>
<div class="ttc" id="agroup__basic__list__operations_ga092c88edc2908df47da55cf882775b67_html_ga092c88edc2908df47da55cf882775b67"><div class="ttname"><a href="group__basic__list__operations_ga092c88edc2908df47da55cf882775b67.html#ga092c88edc2908df47da55cf882775b67">P99_DUPL</a></div><div class="ttdeci">#define P99_DUPL(...)</div><div class="ttdoc">Construct a list that repeats the argument list N times.</div><div class="ttdef"><b>Definition:</b> <a href="p99__list_8h_source.html#l00090">p99_list.h:90</a></div></div>
<div class="ttc" id="agroup__statement__lists_ga8b50ee12a4f501f1701cbeebf4c5e698_html_ga8b50ee12a4f501f1701cbeebf4c5e698"><div class="ttname"><a href="group__statement__lists_ga8b50ee12a4f501f1701cbeebf4c5e698.html#ga8b50ee12a4f501f1701cbeebf4c5e698">P99_VASSIGNS</a></div><div class="ttdeci">#define P99_VASSIGNS(NAME,...)</div><div class="ttdoc">Vector-assign to a list.</div><div class="ttdef"><b>Definition:</b> <a href="p99__map_8h_source.html#l00210">p99_map.h:210</a></div></div>
<div class="ttc" id="ap99__getopt_8h_a57a586489a0c58f01ad0e9d31e7c2eda_html_a57a586489a0c58f01ad0e9d31e7c2eda"><div class="ttname"><a href="p99__getopt_8h_a57a586489a0c58f01ad0e9d31e7c2eda.html#a57a586489a0c58f01ad0e9d31e7c2eda">i</a></div><div class="ttdeci">P00_CLAUSE2 i(_Pragma(&quot;weak  p00_getopt_comp&quot;))(_Pragma(&quot;weak p00_getopt_comp </div></div>
<div class="ttc" id="agroup__preprocessor__text_ga06c6175eb9c536da94dcbb3f985a8f45_html_ga06c6175eb9c536da94dcbb3f985a8f45"><div class="ttname"><a href="group__preprocessor__text_ga06c6175eb9c536da94dcbb3f985a8f45.html#ga06c6175eb9c536da94dcbb3f985a8f45">P99_PASTE5</a></div><div class="ttdeci">#define P99_PASTE5(_1, _2, _3, _4, _5)</div><div class="ttdef"><b>Definition:</b> <a href="p99__paste_8h_source.html#l00087">p99_paste.h:87</a></div></div>
<div class="ttc" id="agroup__preprocessor__text_ga39f23a9e2f85305255b89cb671f39067_html_ga39f23a9e2f85305255b89cb671f39067"><div class="ttname"><a href="group__preprocessor__text_ga39f23a9e2f85305255b89cb671f39067.html#ga39f23a9e2f85305255b89cb671f39067">P99_PASTE</a></div><div class="ttdeci">#define P99_PASTE(...)</div><div class="ttdoc">A left-to-right associative paste operator.</div><div class="ttdef"><b>Definition:</b> <a href="p99__logical_8h_source.html#l00357">p99_logical.h:357</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
